// Generated by CoffeeScript 1.3.1
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;l=null,m=!0,k=200,d=null,g=null,b=function(){var a,b,c,d;c=google.maps.DirectionsStatus,d=[];for(p=a=0,b=c.length;a<b;p=++a)j=c[p],d.push(j);return d}(),o=function(a){return o.marker!=null?o.marker.setPosition(a):o.marker=new google.maps.Marker({position:a,map:l})},c=function(a){return c.marker!=null?c.marker.setPosition(a):c.marker=new google.maps.Marker({position:a,map:l})},i=function(a,b){var c,d,e;return d=[],e=new google.maps.StreetViewService,$("#progress").text("**********"),c=function(f){return e.getPanoramaByLocation(a[f],49,function(e){return function(f,g){var h,i;return g===google.maps.StreetViewStatus.OK?(f.location.latLng.equals(d[d.length-1])||d.push(f.location.latLng),e+1<a.length?(i=Math.floor(10*(e+1)/a.length),$("#progress").text("..........".slice(0,i)+"**********".slice(0,10-i)),c(e+1)):($("#progress").text(""),b(d),h=new google.maps.Polyline({map:l,path:d,strokeColor:"red"}))):console.log("getPanoramaByLocation: "+g)}}(f))},c(0)},f=function(b,c){var d,f,g,h,i;g=[],d=null;for(f=h=0,i=b.length-1;0<=i?h<i:h>i;f=0<=i?++h:--h)g.push({lat:b[f].lat(),lng:b[f].lng(),heading:a(b[f],b[f+1]),duration:d!=null?d/c:0}),d=google.maps.geometry.spherical.computeDistanceBetween(b[f],b[f+1]);return g.push({lat:b[b.length-1].lat(),lng:b[b.length-1].lng(),heading:b.length===1?0:a(b[b.length-2],b[b.length-1]),duration:d!=null?d/c:0}),e(g)},e=function(a){var b,c,d,e,f;d='<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2">\n\n<gx:Tour>\n  <name>your tour</name>\n  <gx:Playlist>\n',c=0;for(e=0,f=a.length;e<f;e++)b=a[e],d+="<gx:FlyTo>\n  <gx:duration>"+b.duration+"</gx:duration>\n  "+(Math.abs(b.heading-c)<15?"<gx:flyToMode>smooth</gx:flyToMode>":"")+'\n  <Camera>\n    <gx:ViewerOptions>\n      <gx:option name="streetview" enabled="1" />\n    </gx:ViewerOptions>\n    <gx:horizFov>85</gx:horizFov>\n    <altitude>2.5</altitude>\n    <longitude>'+b.lng+"</longitude>\n    <latitude>"+b.lat+"</latitude>\n    <heading>"+b.heading+"</heading>\n    <tilt>90</tilt>\n  </Camera>\n</gx:FlyTo>\n",c=b.heading;return d+="    </gx:Playlist>\n  </gx:Tour>\n</kml>\n"},n=function(a){var b,c,d,e,f,g,h,i,j;c=[],i=a.legs;for(e=0,g=i.length;e<g;e++){b=i[e],j=b.steps;for(f=0,h=j.length;f<h;f++)d=j[f],c=c.concat(d.path)}return c},h=function(a,b,c){var d,e;return d=new google.maps.DirectionsService,e={origin:a,destination:b,travelMode:google.maps.DirectionsTravelMode.WALKING},d.route(e,function(a,b){return b===google.maps.DirectionsStatus.OK?c(a.routes[0]):alert("DirectionService: "+b)})},a=function(a,b){var c,d,e,f,g;return a.equals(b)?Number.NaN:(d=a.lat().toRad(),e=b.lat().toRad(),c=(b.lng()-a.lng()).toRad(),g=Math.sin(c)*Math.cos(e),f=Math.cos(d)*Math.sin(e)-Math.sin(d)*Math.cos(e)*Math.cos(c),Math.atan2(g,f).toBrng())},Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return this*180/Math.PI},Number.prototype.toBrng=function(){return(this.toDeg()+360)%360},window.onload=function(){var a,b;return g=new google.maps.Geocoder,a=new google.maps.LatLng(35.757794,139.876819),b={zoom:16,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP},l=new google.maps.Map(document.getElementById("map_canvas"),b),google.maps.event.addListener(l,"click",function(a){return m?(o(a.latLng),$("#origin").val(a.latLng.lat().toString()+","+a.latLng.lng().toString())):(c(a.latLng),$("#destination").val(a.latLng.lat().toString()+","+a.latLng.lng().toString())),m=!m}),$("#route").bind("click",function(){if(o.marker==null||c.marker==null)return;return h(o.marker.getPosition(),c.marker.getPosition(),function(a){var b,c;return c=n(a),b=new google.maps.Polyline({map:l,path:c,strokeColor:"blue"}),c.length<k?i(c,function(a){var b;return b=f(a,parseFloat($("#speed").val())*1e3/60/60),$("#kml").val(b),d.getTourPlayer().setTour(d.parseKml(b)),d.getTourPlayer().play()}):alert("It seems too long path("+c.length+"). Please try shorter one.")})}),$("#address").bind("change",function(){return console.log("pass"),g.geocode({address:this.value},function(a,b){return b===google.maps.GeocoderStatus.OK?l.setCenter(a[0].geometry.location):alert(b)})})},google.setOnLoadCallback(function(){return google.earth.createInstance("map3d",function(a){return d=a,d.getWindow().setVisibility(!0)},function(){})})}).call(this);